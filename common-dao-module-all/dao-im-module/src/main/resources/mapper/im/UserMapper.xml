<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.minimalism.im.mapper.im.UserMapper">
  <resultMap id="BaseResultMap" type="com.minimalism.im.domain.im.User">
    <!--@mbg.generated-->
    <!--@Table `user`-->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="username" jdbcType="VARCHAR" property="username" />
    <result column="password" jdbcType="VARCHAR" property="password" />
    <result column="image" jdbcType="VARCHAR" property="image" />
    <result column="nickname" jdbcType="VARCHAR" property="nickname"/>
  </resultMap>
  <sql id="Base_Column_List">
    <!--@mbg.generated-->
    `id`, `nickname`,`username`, `password`, `image`
  </sql>

  <sql id="Base_Column_User_List">
    <!--@mbg.generated-->
    `user`.id,`user`.username,`user`.nickname,`user`.`password`,`user`.image
  </sql>

  <sql id="isFriend">
       , exists(select 1 from `friend` f where f.`uid` = #{id} and f.`fid` = `user`.id) as is_friend
  </sql>

  <sql id="isSelf">
      <!--@sql select `user`.*-->
      ,(`user`.id = #{id}) as is_self
      <!--@sql from `user`-->
  </sql>

  <sql id="isApply">
    ,exists(select 1 from `apply` a where a.`uid` = #{id} and a.`tid` = `user`.id) as is_apply
  </sql>

    <!--auto generated by MybatisCodeHelper on 2023-08-10-->
    <select id="getById" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from `user`
        where `id` = #{id,jdbcType=BIGINT}
    </select>

    <select id="getFriends" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from `user`
        where id in (select f.fid from `friend` f where f.`uid` = #{id})
        <if test="(nickname != null and nickname != '') and (username == null or username == '')">
            and `nickname` like concat(#{nickname}, '%')
        </if>
        <if test="(username != null and username != '')and (nickname == null or nickname == '')">
            and `username` like concat(#{username}, '%')
        </if>
        <if test="(username != null and username != '') or (nickname != null and nickname != '')">
            and (`username` like concat(#{username}, '%')
                or `nickname` like concat(#{nickname}, '%')
                )
        </if>
    </select>

    <select id="applyList" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_User_List"/>,a.id as apply_id
        from `user`
        left join `apply` a on a.`uid` = `user`.`id`
        where a.`tid` = #{userId}
    </select>

  <select id="getUsers" resultMap="BaseResultMap">
      select <include refid="Base_Column_User_List"/>
      , exists(select 1 from `friend` f where f.`uid` = #{id} and f.`fid` = `user`.id) as isFriend
      , (`user`.id = #{id}) as isSelf
      ,exists(select 1 from `apply` a where a.`uid` = #{id} and a.`tid` = `user`.id) as isApply
      from `user`
      <where>
          `user`.id != #{id}
          <if test="(nickname != null and nickname != '') or (username != null and username != '')">
              and (`user`.`username` like concat(#{username}, '%')
              or `user`.`nickname` like concat(#{nickname}, '%')
                      )
          </if>
      </where>
  </select>

  <select id="getUser" resultMap="BaseResultMap">
      select u.*
      from `user` u
               inner join `chat_user` cu on cu.`user_id` = u.`id`
               inner join `chat_window` cw on cu.`chat_id` = cw.`chat_id`
      where cw.`chat_type` = #{chatType.name}
        and cu.`chat_type` = #{chatType.name}
        and cu.`chat_id` = #{chatId}
        and cu.`user_id` != #{userId}
  </select>

  <select id="getOneUser" resultMap="BaseResultMap">
      select
      <include refid="Base_Column_User_List"/>
      ,`user`.`id`= #{nowUserId} as is_self
      , exists(select 1 from `friend` f where f.`uid` = #{nowUserId} and f.`fid` = `user`.id) as is_friend
      , exists(select 1 from `apply` a where a.`uid` = #{nowUserId} and a.`tid` = `user`.id) as is_apply
      , (select cu.`chat_id` from `chat_user` cu
      inner join `chat_user`  cu1 on cu.`chat_id` = cu1.`chat_id`
      where cu.`user_id` = #{userId} and cu1.`user_id` = #{nowUserId} and cu.`chat_type` = cu1.`chat_type`and cu1.`chat_type` = 'ONE_ON_ONE_CHAT')
      as chat_id
      from `user`
      where `user`.`id` = #{userId}
  </select>
</mapper>